/*global ga*/

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); // Note: https protocol here
 
ga('create', 'UA-37203159-4', 'auto');
ga('set', 'checkProtocolTask', function(){}); // Removes failing protocol check. @see: http://stackoverflow.com/a/22152353/1958200
ga('require', 'displayfeatures');

function event(category, action, label) {
	if (sendAnalytics){
		ga('send', {
			'hitType': 'event',          // Required.
			'eventCategory': category,   // Required.
			'eventAction': action,      // Required.
			'eventLabel': label
		});
	}
}

function valueEvent(category, label, action, value) {
	if (sendAnalytics){
		ga('send', {
			'hitType': 'event',          // Required.
			'eventCategory': category,   // Required.
			'eventAction': action,      // Required.
			'eventLabel': label,
			'eventValue': value
		});
	}
}

function noninteractionEvent(category, label) {
	if (sendAnalytics){
		ga('send', {
			'hitType': 'event',          // Required.
			'eventCategory': category,   // Required.
			'eventAction': action,      // Required.
			'eventLabel': label,
			'nonInteraction': 1
		});
	}
}

function buttonEvent(label) {
	event('button','click', label);
}

function linkEvent(label) {
	event('link','click', label);
}

function dialogEvent(label) {
	event('dialog', 'trigger', label);
}

function dialogButton(label) {
	event('dialog', 'action', label);
}

function tabEvent(label) {
	event('tab', 'switch', label);
}

function themeEvent(category, label) {
	event('theme', category, label);
}

function settingEvent(category, label) {
	event('setting', category, label);
}

/*global chrome*/

function getSetting(name, callback) {
	chrome.storage.sync.get(name, function(data) {
		callback(data);
	}); 
}

function getStartpage(callback) {
	getSetting("startupmode", function(data) {
		if (data.startupmode === undefined) {
			chrome.storage.sync.set({startupmode: "all-themes"});
		}
		callback(data.startupmode);
	});
}

function checkAnalyticsOptout(callback){
	getSetting("analyticsoptout", function(data){
		if (data.analyticsoptout === undefined) {
			chrome.storage.sync.set({analyticsoptout: false});
		}
		callback(data.analyticsoptout);
	});
}

function setFaves(faves){
	chrome.storage.sync.set({favorites: faves});
}

function getFaves(callback){
	getSetting("favorites", function(data) {
		if (data.favorites === undefined) {
			setFaves("");
		}
		callback(data.favorites);
	});
}


function checkFaved(t, callback) {
	getFaves(function(data){
		var faves = data.split(" ");
		if (faves.indexOf(t) > -1) {
			callback(true);
		}
		else {
			callback(false);
		}
	});
}

function addFave(t) {
	getFaves(function(data){
		var s = data+" "+t;
		s = s.trim();
		setFaves(s);
		themeEvent("add-fave", t);
	});
}

function removeFave(t) {
	getFaves(function(data){
		data = data.replace(t + " ", "");
		data = data.replace(t, "");
		setFaves(data.trim());
		themeEvent("remove-fave", t);
	});
}

function toggleFave(t) {
	checkFaved(t, function(isFaved) {
		if (isFaved) {
			removeFave(t);
			
			var activeTab = $("menu li.active").data('target');
			
			if (activeTab === "faves") {
				$("#theme-" + t).hide();
				if ($(".theme-block.theme-faved").length === 0) {
					$("#no-faves").show();
				}
			}
		}
		else {
			addFave(t);
		}
	});
}

function clearFaves(){
	setFaves("");
}

// define our themes
var themes = ['cerulean','cosmo','cyborg','darkly','flatly','journal','lumen','paper','readable','sandstone','simplex','slate','spacelab','superhero','united','yeti'];

function prepPage() {
	chrome.tabs.executeScript(null, {file: "target_page/inject.js"}, function(){
		if (chrome.runtime.lastError != undefined) {
			dialogEvent("page-not-allowed");
			$("#page-not-allowed").show();
		}
	});
}

function setTheme(t) {

	var themeFile = chrome.extension.getURL('themes/'+t+'.css');
	chrome.tabs.executeScript(null, {
		code: 'document.getElementById("bootswatch-style").setAttribute("href", "'+ themeFile +'");'+"\n"+
			'var originalSheet=document.getElementById("original-stylesheet");'+"\n"+
			'if (originalSheet!=null) { originalSheet.disabled = true; }'+"\n"+
			'document.getElementById("last-theme").value = \''+ t +'\';\n'+
			'cacheControl();'
	});

	$("#download").attr('href', "http://maxcdn.bootstrapcdn.com/bootswatch/3.3.4/"+ t +"/bootstrap.min.css").data('galabel', 'Download: ' + t );

	checkFaved(t, function(isFaved){
		if (isFaved) {
			$("#favorite i").addClass("md-favorite").removeClass("md-favorite-outline");
		}
		else {
			$("#favorite i").removeClass("md-favorite").addClass("md-favorite-outline");
		}
	});

}

function clearTheme() {
	chrome.tabs.executeScript(null, {file: "target_page/reset.js"});
	//$("#theme-specific-actions").hide();
	$('.theme-icon.active').toggleClass('active');
	$("#theme-specific-actions .button").addClass('disabled');

	chrome.tabs.executeScript(null, {
		code: 'document.getElementById("last-theme").value = \'\';'
	});
}

function loadThemes() {
	$("#no-bootstrap").hide();
	$("#theme-actions").show();

	for (var t in themes) {
		t = themes[t];

		$("#themes").append(''+
			'<div class="theme-block" id="theme-' + t + '" data-theme="' + t + '">'+
				'<div class="theme-icon">'+
					'<span>Sample</span>'+
					'<div class="color primary"></div>'+
					'<div class="color color-half success"></div>'+
					'<div class="color color-half info"></div>'+
					'<div class="color color-half warning"></div>'+
					'<div class="color color-half danger"></div>'+
				'</div>' +
				'<div class="theme-name">'+
					t +
				'</div>'+
			'</div>');


	}

	$(".theme-block").click(function(){
		var t = $(this).data('theme');
		setTheme(t);
		$('.theme-icon.active').toggleClass('active');
		$(this).find('.theme-icon').toggleClass('active');
		//$("#theme-specific-actions").show();
		$("#theme-specific-actions .button").removeClass('disabled');
		themeEvent("apply", t);
	}).each(function(){
		var t = $(this).data('theme');
		checkFaved(t, function(isFaved){
			//console.log("hi");
			if (isFaved) {
				//console.log("hello");
				$("#theme-"+t).addClass('theme-faved');
			}
		});
	});

	getStartpage(function(startupMode){
		if (startupMode == "favorites") {
			var startSection = $("section.active");

			if (startSection.attr('id') !== "section-themes") {
				$("section.active").removeClass('active');
			}

			$("#section-themes").addClass('active');
			$("#theme-actions").show();

			$("#themes .theme-block:not(.theme-faved)").hide();

			$("menu ul li[data-target=themes]").removeClass('active');
			$("menu ul li[data-target=faves]").addClass('active');

			if ($(".theme-block.theme-faved").length === 0) {
				$("#no-faves").show();
			}

			$("#startup-select :nth-child(2)").prop('selected', true);
		}
	});

	checkAnalyticsOptout(function(optout){
		$("#card-analytics input[type=checkbox]").prop("checked", optout);
	});
}


// @codekit-prepend "../js/analytics.js","../js/settings_functions.js","../js/theme_functions.js"

var sendAnalytics = true;

checkAnalyticsOptout(function(optout){
	sendAnalytics = !optout;
});

if (sendAnalytics) {
	ga('send', 'pageview', '/popup.html');
}

var closeSnackbar = null;

function snackbar(text){
	if ($("#snackbar").hasClass("open")) {
		$("#snackbar").text(text);
		clearTimeout(closeSnackbar);
		closeSnackbar = setTimeout(function(){
			$("#snackbar").removeClass('open');
		}, 3000);
	}
	else {
		setTimeout(function(){
			$("#snackbar").text(text).addClass('open');
		}, 500);
		closeSnackbar = setTimeout(function(){
			$("#snackbar").removeClass('open');
		}, 3000);
	}
}

$(document).ready(function(){

	prepPage();

	$(".dialog").hide();

	$("a").click(function(){
		var href = $(this).attr('href');
		var gaLabel = $(this).data('galabel') ? $(this).data('galabel') : $(this).text();

		if (href !== "#") {
			linkEvent(gaLabel);
			chrome.tabs.create({url: $(this).attr('href')});
			return false;
		}

	});

	chrome.runtime.onMessage.addListener(function(message){
		if (message.method === "bootstrapStatus") {
			var hasBootstrap = (message.title === "true") ? true : false;

			loadThemes();

			if (!hasBootstrap) {
				$("#no-bootstrap").show();
				dialogEvent("no-bootstrap");
			}

		}

		if (message.method === "themeAlreadySet") {
			$("#no-bootstrap").hide();
			if (message.title !== "") {
				$("#theme-" + message.title + " .theme-icon").addClass('active');
				$("#theme-specific-actions .button").removeClass('disabled');
				//$("#theme-specific-actions").show();

				checkFaved(message.title, function(isFaved){
					if (isFaved) {
						$("#favorite i").addClass("md-favorite").removeClass("md-favorite-outline");
					}
				});
			}

		}
	});

	$("#load-anyway").click(function(){
		$("#reset,#theme-actions").show();
		$("#no-bootstrap").hide();
		dialogButton("no-bootstrap: continue");
	});

	$("#load-anyway-cancel").click(function(){
		clearTheme();
		dialogButton("no-bootstrap: cancel");
		window.close();
	});

	$("#not-allowed-close").click(function(event) {
		window.close();
	});

	$("#reset").click(function(){
		clearTheme();
		themeEvent("reset","");
	});

	$("#hamburger").click(function(){
		$("menu").toggleClass("open");
		$("#menu-shade").fadeIn();
	});

	$("#menu-shade").click(function(){
		$("menu").toggleClass("open");
		$("#menu-shade").fadeOut();
	});

	$("menu ul li:not([data-target=faves]):not(.menu-divider)").click(function(){
		$("section.active").removeClass('active');
		$("#themes .theme-block").show();

		$("#no-faves").hide();

		$("menu ul li.active").removeClass('active');
		$(this).addClass('active');

		var targetName = $(this).data("target");

		var target = $("section#section-" + targetName);
		target.addClass('active');

		$("menu").toggleClass("open");
		$("#menu-shade").fadeOut();

		if (targetName !== "themes") {
			$("#theme-actions").hide();
		}
		else {
			$("#theme-actions").show();
		}

		tabEvent(targetName);

	});

	$("menu ul li[data-target=faves]").click(function(){
		var startSection = $("section.active");

		if (startSection.attr('id') !== "section-themes") {
			$("section.active").removeClass('active');
		}

		$("#section-themes").addClass('active');
		$("#theme-actions").show();

		$("#themes .theme-block:not(.theme-faved)").hide();

		$("menu ul li.active").removeClass('active');
		$(this).addClass('active');

		$("menu").toggleClass("open");
		$("#menu-shade").fadeOut();

		if ($(".theme-block.theme-faved").length === 0) {
			$("#no-faves").show();
		}

		tabEvent("faves");

	});


	$("#favorite").click(function(){
		var item = $(".theme-block .theme-icon.active").parent();
		var t = item.data('theme');

		item.toggleClass("theme-faved");

		toggleFave(t);
		$("#favorite i").toggleClass("md-favorite").toggleClass("md-favorite-outline");

		if ($("menu ul li[data-target=faves]").hasClass('active')) {
			$("#theme-specific-actions .button").addClass('disabled');
		}

	});

	$("#fave-clear").click(function(){
		$("#fave-clear-verify").show();
		dialogEvent("clear-faves");
	});

	$("#fave-clear-no").click(function(){
		$("#fave-clear-verify").hide();
		dialogButton("clear-faves: no");
	});

	$("#fave-clear-yes").click(function(){
		clearFaves();
		$("#fave-clear-verify").hide();
		$(".theme-block.theme-faved").removeClass("theme-faved");
		snackbar("Favorites Cleared!");
		dialogButton("clear-faves: yes");
	});

	$("#startup-select").change(function(){
		var mode = $(this).val().toLowerCase().replace(" ", "-");
		chrome.storage.sync.set({startupmode: mode});
		settingEvent("startup", mode);
	});

	$("#card-analytics input[type=checkbox]").change(function(event) {
		var checked = $(this).prop('checked');
		chrome.storage.sync.set({analyticsoptout: checked});
		settingEvent("analytics opt out", (checked?"enable":"disable"));
		sendAnalytics = !checked;
	});

});


