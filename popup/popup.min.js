/*global chrome*/

function getSetting(name, callback) {
	chrome.storage.sync.get(name, function(data) {
		callback(data);
	}); 
}

function setFaves(faves){
	chrome.storage.sync.set({favorites: faves});
}

function getFaves(callback){
	getSetting("favorites", function(data) {
		if (data.favorites === undefined) {
			setFaves("");
		}
		callback(data.favorites);
	});
}


function checkFaved(t, callback) {
	getFaves(function(data){
		var faves = data.split(" ");
		if (faves.indexOf(t) > -1) {
			callback(true);
		}
		else {
			callback(false);
		}
	});
}

function addFave(t) {
	getFaves(function(data){
		var s = data+" "+t;
		s = s.trim();
		setFaves(s);
	});
}

function removeFave(t) {
	getFaves(function(data){
		data = data.replace(t + " ", "");
		data = data.replace(t, "");
		setFaves(data.trim());
	});
}

function toggleFave(t) {
	checkFaved(t, function(isFaved) {
		if (isFaved) {
			removeFave(t);
			
			var activeTab = $("menu li.active").data('target');
			
			if (activeTab === "faves") {
				$("#theme-" + t).hide();
				if ($(".theme-block.theme-faved").length === 0) {
					$("#no-faves").show();
				}
			}
		}
		else {
			addFave(t);
		}
	});
}

function clearFaves(){
	setFaves("");
}

// define our themes
var themes = ['cerulean','cosmo','cyborg','darkly','flatly','journal','lumen','paper','readable','sandstone','simplex','slate','spacelab','superhero','united','yeti'];

function prepPage() {
	chrome.tabs.executeScript(null, {file: "target_page/inject.js"});
}

function setTheme(t) {
			
	var themeFile = chrome.extension.getURL('themes/'+t+'.css');
	chrome.tabs.executeScript(null, {
		code: 'document.getElementById("bootswatch-style").setAttribute("href", "'+ themeFile +'");'+"\n"+
			'var originalSheet=document.getElementById("original-stylesheet");'+"\n"+
			'if (originalSheet!=null) { originalSheet.disabled = true; }'+"\n"+
			'document.getElementById("last-theme").value = \''+ t +'\';\n'+
			'cacheControl();'
	});
	
	$("#download").attr('href', "http://maxcdn.bootstrapcdn.com/bootswatch/3.3.4/"+ t +"/bootstrap.min.css");
	
	checkFaved(t, function(isFaved){
		if (isFaved) {
			$("#favorite i").addClass("md-favorite").removeClass("md-favorite-outline");
		} 
		else {
			$("#favorite i").removeClass("md-favorite").addClass("md-favorite-outline");
		}
	});
	
}

function clearTheme() {
	chrome.tabs.executeScript(null, {file: "target_page/reset.js"});
	//$("#theme-specific-actions").hide();
	$('.theme-icon.active').toggleClass('active');
	$("#theme-specific-actions .button").addClass('disabled');
	
	chrome.tabs.executeScript(null, {
		code: 'document.getElementById("last-theme").value = \'\';'
	});
}

function loadThemes() {
	$("#no-bootstrap").hide();
	$("#theme-actions").show();
	
	for (var t in themes) {
		t = themes[t];
			
		$("#themes").append(''+
			'<div class="theme-block" id="theme-' + t + '" data-theme="' + t + '">'+
				'<div class="theme-icon">'+
					'<span>Sample</span>'+
					'<div class="color primary"></div>'+
					'<div class="color color-half success"></div>'+
					'<div class="color color-half info"></div>'+
					'<div class="color color-half warning"></div>'+
					'<div class="color color-half danger"></div>'+
				'</div>' +
				'<div class="theme-name">'+
					t + 
				'</div>'+
			'</div>');
		
		
	}
	
	$(".theme-block").click(function(){
		setTheme($(this).data('theme'));
		$('.theme-icon.active').toggleClass('active');
		$(this).find('.theme-icon').toggleClass('active');
		//$("#theme-specific-actions").show();
		$("#theme-specific-actions .button").removeClass('disabled');
	}).each(function(){
		var t = $(this).data('theme');
		checkFaved(t, function(isFaved){
			//console.log("hi");
			if (isFaved) {
				//console.log("hello");
				$("#theme-"+t).addClass('theme-faved');
			}
		});
	});
}

// @codekit-prepend "../js/fave_functions.js","../js/theme_functions.js"

var closeSnackbar = null;

function snackbar(text){
	if ($("#snackbar").hasClass("open")) {
		$("#snackbar").text(text);
		clearTimeout(closeSnackbar);
		closeSnackbar = setTimeout(function(){
			$("#snackbar").removeClass('open');
		}, 3000); 
	}
	else {
		setTimeout(function(){
			$("#snackbar").text(text).addClass('open');
		}, 500);
		closeSnackbar = setTimeout(function(){
			$("#snackbar").removeClass('open');
		}, 3000);
	}
}

$(document).ready(function(){
	
	prepPage();
	
	$(".dialog").hide();
	
	$("a").click(function(){
		var href = $(this).attr('href');
		
		if (href !== "#") {
			chrome.tabs.create({url: $(this).attr('href')});
			return false;
		}
	});
	
	chrome.runtime.onMessage.addListener(function(message){
		if (message.method === "bootstrapStatus") {
			var hasBootstrap = (message.title === "true") ? true : false;
			
			loadThemes();
			
			if (!hasBootstrap) {
				$("#no-bootstrap").show();
			}
			
		}
		
		if (message.method === "themeAlreadySet") {
			$("#no-bootstrap").hide();
			if (message.title !== "") {
				$("#theme-" + message.title + " .theme-icon").addClass('active');
				$("#theme-specific-actions .button").removeClass('disabled');
				//$("#theme-specific-actions").show();
				
				checkFaved(message.title, function(isFaved){
					if (isFaved) {
						$("#favorite i").addClass("md-favorite").removeClass("md-favorite-outline");
					}
				});
			}
			
		}
	});
	
	$("#load-anyway").click(function(){
		$("#reset,#theme-actions").show();
		$("#no-bootstrap").hide();
	});
	
	$("#load-anyway-cancel").click(function(){
		clearTheme();
		window.close();
	});
	
	$("#reset").click(function(){
		clearTheme();
	});
	
	$("#hamburger").click(function(){
		$("menu").toggleClass("open");
		$("#menu-shade").fadeIn();
	});
	
	$("#menu-shade").click(function(){
		$("menu").toggleClass("open");
		$("#menu-shade").fadeOut();
	});
	
	$("menu ul li:not([data-target=faves]):not(.menu-divider)").click(function(){
		$("section.active").removeClass('active');
		$("#themes .theme-block").show();
		
		$("#no-faves").hide();
		
		$("menu ul li.active").removeClass('active');
		$(this).addClass('active');
		
		var targetName = $(this).data("target");
		
		var target = $("section#section-" + targetName);
		target.addClass('active');
		
		$("menu").toggleClass("open");
		$("#menu-shade").fadeOut();
		
		if (targetName !== "themes") {
			$("#theme-actions").hide();
		}
		else {
			$("#theme-actions").show();
		}
		
	});
	
	$("menu ul li[data-target=faves]").click(function(){
		var startSection = $("section.active");
		
		if (startSection.attr('id') !== "section-themes") {
			$("section.active").removeClass('active');
		}
		
		$("#section-themes").addClass('active');
		$("#theme-actions").show();
		
		$("#themes .theme-block:not(.theme-faved)").hide();
		
		$("menu ul li.active").removeClass('active');
		$(this).addClass('active');
		
		$("menu").toggleClass("open");
		$("#menu-shade").fadeOut();
		
		if ($(".theme-block.theme-faved").length === 0) {
			$("#no-faves").show();
		}
		
	});
	
	
	$("#favorite").click(function(){
		var item = $(".theme-block .theme-icon.active").parent();
		var t = item.data('theme');
		
		item.toggleClass("theme-faved");
		
		toggleFave(t);
		$("#favorite i").toggleClass("md-favorite").toggleClass("md-favorite-outline");
		
		if ($("menu ul li[data-target=faves]").hasClass('active')) {
			$("#theme-specific-actions .button").addClass('disabled');
		}
		
	});
	
	$("#fave-clear").click(function(){
		$("#fave-clear-verify").show();
	});
	
	$("#fave-clear-no").click(function(){
		$("#fave-clear-verify").hide();
	});
	
	$("#fave-clear-yes").click(function(){
		clearFaves();
		$("#fave-clear-verify").hide();
		$(".theme-block.theme-faved").removeClass("theme-faved");
		snackbar("Favorites Cleared!");
	});
	
	$("#startup-select").change(function(){
		var mode = $(this).val().toLowerCase().replace(" ", "_");
		chrome.storage.sync.set({startupMode: mode});
	});
	
});

